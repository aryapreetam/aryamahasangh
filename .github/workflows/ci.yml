name: ðŸ”¨ Continuous Integration

on:
  push:
    branches: [ main, master, develop, dev ]
  pull_request:
    branches: [ main, master, dev ]

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2

jobs:
  generate-version:
    name: ðŸ“‹ Generate Version
    runs-on: ubuntu-latest
    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Generate build version
        id: version
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          VERSION_NAME="1.0.$BUILD_NUMBER"
          VERSION_CODE=$((10000 + BUILD_NUMBER))
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          echo "ðŸ·ï¸ Version: $VERSION_NAME ($VERSION_CODE)"

  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: generate-version
    strategy:
      matrix:
        target: [android, web, desktop]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-home-cache-cleanup: true

      - name: Create local.properties
        run: |
          echo "app_version=${{ needs.generate-version.outputs.version_name }}" >> local.properties
          echo "environment=dev" >> local.properties
          echo "dev_supabase_url=${{ secrets.SUPABASE_URL }}" >> local.properties
          echo "dev_supabase_key=${{ secrets.SUPABASE_KEY }}" >> local.properties
          echo "dev_server_url=https://your-api-server.com" >> local.properties
          echo "dev_googlemaps_apikey=${{ secrets.GOOGLE_MAPS_API_KEY }}" >> local.properties

      - name: Build Android APK
        if: matrix.target == 'android'
        run: |
          ./gradlew assembleDebug assembleRelease
          echo "ðŸ“± Android build completed"

      - name: Build Web Distribution
        if: matrix.target == 'web'
        run: |
          ./gradlew wasmJsBrowserDistribution
          echo "ðŸŒ Web build completed"

      - name: Build Desktop Distribution
        if: matrix.target == 'desktop'
        run: |
          ./gradlew createDistributable packageDistributionForCurrentOS
          echo "ðŸ–¥ï¸ Desktop build completed"

      - name: Run Tests
        run: ./gradlew test --continue

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-artifacts-${{ needs.generate-version.outputs.version_name }}
          path: |
            composeApp/build/outputs/
            composeApp/build/dist/
            composeApp/build/compose/binaries/
          retention-days: 30

  # Build Report Job
  build-report:
    name: ðŸ“Š Build Report
    runs-on: ubuntu-latest
    needs: [generate-version, build-and-test]
    if: always()
    steps:
      - name: Build Status Report
        run: |
          echo "## ðŸš€ Build Report for ${{ needs.generate-version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.generate-version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ needs.generate-version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY