name: CI Pipeline

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

permissions:
  security-events: write    # Required for uploading security scan results
  contents: write          # Required for creating releases and artifacts
  actions: write          # Required for workflow operations
  checks: write           # Required for status checks
  pull-requests: write    # Required for PR comments
  issues: write           # Required for issue comments

env:
  ENVIRONMENT: dev
  SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://placeholder.supabase.co' }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY || 'placeholder-key' }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create secrets.properties
        run: |
          cp secrets.properties.template secrets.properties
          sed -i 's|dev.supabase.url=|dev.supabase.url=https://placeholder.supabase.co|' secrets.properties
          sed -i 's|dev.supabase.key=|dev.supabase.key=placeholder-key|' secrets.properties
          sed -i 's|prod.supabase.url=|prod.supabase.url=https://placeholder.supabase.co|' secrets.properties
          sed -i 's|prod.supabase.key=|prod.supabase.key=placeholder-key|' secrets.properties

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4  # Update to v4
        with:
          name: test-results
          path: |
            **/build/test-results/
            **/build/reports/

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create secrets.properties
        run: |
          cp secrets.properties.template secrets.properties
          sed -i 's|dev.supabase.url=|dev.supabase.url=https://placeholder.supabase.co|' secrets.properties
          sed -i 's|dev.supabase.key=|dev.supabase.key=placeholder-key|' secrets.properties
          sed -i 's|prod.supabase.url=|prod.supabase.url=https://placeholder.supabase.co|' secrets.properties
          sed -i 's|prod.supabase.key=|prod.supabase.key=placeholder-key|' secrets.properties

      - name: Make gradlew executable
        run: chmod +x ./gradlew

  #    - name: Run ktlint
  #      run: ./gradlew ktlintCheck --no-daemon
  #
  #    - name: Run detekt
  #      run: ./gradlew detekt --no-daemon
  #
  #    - name: Upload code quality reports
  #      uses: actions/upload-artifact@v4  # Updated from v3 to v4
  #      if: always()
  #      with:
  #        name: code-quality-reports
  #        path: |
  #          **/build/reports/ktlint/
  #          **/build/reports/detekt/

  build:
    name: Build All Platforms
    runs-on: ubuntu-latest
    needs: [ test, code-quality ]
    
    strategy:
      matrix:
        target: [ compileKotlinAndroid, compileKotlinDesktop, compileKotlinWasmJs ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Create secrets.properties
        run: |
          cp secrets.properties.template secrets.properties
          sed -i "s|dev.supabase.url=|dev.supabase.url=${SUPABASE_URL}|" secrets.properties
          sed -i "s|dev.supabase.key=|dev.supabase.key=${SUPABASE_KEY}|" secrets.properties
          sed -i 's|prod.supabase.url=|prod.supabase.url=https://placeholder.supabase.co|' secrets.properties
          sed -i 's|prod.supabase.key=|prod.supabase.key=placeholder-key|' secrets.properties

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build ${{ matrix.target }}
        run: ./gradlew ${{ matrix.target }} --no-daemon

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3  # Updated from v2 to v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  deploy-wasm:
    name: Deploy WasmJs to Netlify
    if: github.ref == 'refs/heads/dev'
    needs: [ test, code-quality ]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build WasmJs
        run: ./gradlew wasmJsBrowserDistribution

      - name: Create Archive
        run: |
          cd composeApp/build/dist/wasmJs/productionExecutable
          zip -r ../../../../../Archive.zip .

      - name: Generate Release Name
        id: release-name
        run: echo "::set-output name=name::aryamahasangh_web_$(date +'%Y%m%d_%H%M%S')"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Archive.zip
          tag_name: ${{ steps.release-name.outputs.name }}
          name: ${{ steps.release-name.outputs.name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './composeApp/build/dist/wasmJs/productionExecutable'
          production-branch: dev
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from GitHub Actions'
          enable-pull-request-comment: false
          enable-commit-comment: false
          enable-commit-status: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  android-release:
    name: Android Release Build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    needs: [ test, code-quality ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Decode Keystore
        run: |
          echo ${{ secrets.KEYSTORE_BASE64 }} | base64 -d > aryamahasangh.jks

      - name: Create secrets.properties
        run: |
          cp secrets.properties.template secrets.properties
          sed -i 's|dev.supabase.url=|dev.supabase.url=${{ secrets.SUPABASE_URL }}|' secrets.properties
          sed -i 's|dev.supabase.key=|dev.supabase.key=${{ secrets.SUPABASE_KEY }}|' secrets.properties
          sed -i 's|prod.supabase.url=|prod.supabase.url=${{ secrets.SUPABASE_URL }}|' secrets.properties
          sed -i 's|prod.supabase.key=|prod.supabase.key=${{ secrets.SUPABASE_KEY }}|' secrets.properties

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release APK
        run: ./gradlew :composeApp:assembleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Generate release timestamp
        id: timestamp
        run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: composeApp/build/outputs/apk/release/composeApp-release.apk
          tag_name: android_release_${{ steps.timestamp.outputs.timestamp }}
          name: AryaMahasangh_${{ steps.timestamp.outputs.timestamp }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
