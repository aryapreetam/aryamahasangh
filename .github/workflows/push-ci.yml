name: CI (Push & Pull Request)

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - 'v*'
    paths:
      - 'composeApp/**'
      - 'gradle/**'
      - 'gradle.properties'
      - 'settings.gradle.kts'
      - 'build.gradle.kts'
      - '.github/workflows/**'
      - 'maestro-tests/**'
  pull_request:
    paths:
      - 'composeApp/**'
      - 'gradle/**'
      - 'gradle.properties'
      - 'settings.gradle.kts'
      - 'build.gradle.kts'
      - '.github/workflows/**'
      - 'maestro-tests/**'

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: Run All Tests & Builds
    uses: ./.github/workflows/ci-reusable.yml

  build-deploy-dev:
    name: Build & Deploy Dev
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/develop'
    environment: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Create local.properties for Dev
        run: |
          echo "app_version=1.0.${{ github.run_number }}" >> local.properties
          echo "environment=dev" >> local.properties
          echo "dev_supabase_url=${{ secrets.SUPABASE_URL }}" >> local.properties
          echo "dev_supabase_key=${{ secrets.SUPABASE_KEY }}" >> local.properties
          echo "dev_server_url=https://dev-api.aryamahasangh.org" >> local.properties

      - name: Build Web for Dev
        run: ./gradlew :composeApp:wasmJsBrowserDistribution

      - name: Deploy to Netlify Dev
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './composeApp/build/dist/wasmJs/productionExecutable'
          production-branch: dev
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'ðŸš€ Dev v1.0.${{ github.run_number }} - ${{ github.sha }}'
          enable-pull-request-comment: false
          enable-commit-comment: true
          enable-commit-status: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Build Android APK for Dev
        run: ./gradlew :composeApp:assembleDebug

      - name: Upload Dev Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-artifacts-${{ github.run_number }}
          path: |
            composeApp/build/outputs/apk/debug/*.apk
            composeApp/build/dist/wasmJs/productionExecutable/
          retention-days: 7

  build-deploy-staging:
    name: Build & Deploy Staging
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Create local.properties for Staging
        run: |
          echo "app_version=1.0.${{ github.run_number }}" >> local.properties
          echo "environment=staging" >> local.properties
          echo "staging_supabase_url=${{ secrets.SUPABASE_URL }}" >> local.properties
          echo "staging_supabase_key=${{ secrets.SUPABASE_KEY }}" >> local.properties
          echo "staging_server_url=https://staging-api.aryamahasangh.org" >> local.properties

      - name: Build Web for Staging
        run: ./gradlew :composeApp:wasmJsBrowserDistribution

      - name: Deploy to Netlify Staging
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: './composeApp/build/dist/wasmJs/productionExecutable'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'ðŸš€ Staging v1.0.${{ github.run_number }} - ${{ github.sha }}'
          enable-pull-request-comment: false
          enable-commit-comment: true
          enable-commit-status: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Build Android Release APK for Staging
        run: ./gradlew :composeApp:assembleRelease

      - name: Upload Staging Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-artifacts-${{ github.run_number }}
          path: |
            composeApp/build/outputs/apk/release/*.apk
            composeApp/build/dist/wasmJs/productionExecutable/
          retention-days: 30

  build-report:
    name: ðŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [ci]
    if: always()
    steps:
      - name: Create Summary Report
        run: |
          echo "## ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **CI Status**: ${{ needs.ci.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/dev" ] || [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "### ðŸš€ Deployed to Dev Environment" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
            echo "### ðŸš€ Deployed to Staging Environment" >> $GITHUB_STEP_SUMMARY
          fi

