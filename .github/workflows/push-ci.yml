name: CI (Push & Pull Request)

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - 'v*'
    paths:
      - 'composeApp/**'
      - 'gradle/**'
      - 'gradle.properties'
      - 'settings.gradle.kts'
      - 'build.gradle.kts'
      - '.github/workflows/**'
      - 'maestro-tests/**'
      - 'supabase/**'  # Trigger on database changes
      - 'scripts/**'
  pull_request:
    paths:
      - 'composeApp/**'
      - 'gradle/**'
      - 'gradle.properties'
      - 'settings.gradle.kts'
      - 'build.gradle.kts'
      - '.github/workflows/**'
      - 'maestro-tests/**'
      - 'supabase/**'  # Trigger on database changes

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Parse version from gradle.properties (source of truth)
  parse-version:
    name: ðŸ“‹ Parse Version from gradle.properties
    runs-on: ubuntu-latest
    outputs:
      base_version: ${{ steps.version.outputs.base_version }}
      version_dev: ${{ steps.version.outputs.version_dev }}
      version_staging: ${{ steps.version.outputs.version_staging }}
      version_code: ${{ steps.version.outputs.version_code }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse version from gradle.properties
        id: version
        run: |
          # Read version from gradle.properties
          MAJOR=$(grep '^version.major=' gradle.properties | cut -d'=' -f2)
          MINOR=$(grep '^version.minor=' gradle.properties | cut -d'=' -f2)
          PATCH=$(grep '^version.patch=' gradle.properties | cut -d'=' -f2)
          
          BASE_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Calculate version code (same logic as AppConfig.calculateVersionCode)
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          
          # Generate environment-specific versions
          VERSION_DEV="${BASE_VERSION}-dev-${SHORT_SHA}"
          VERSION_STAGING="${BASE_VERSION}-staging"
          
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "version_dev=${VERSION_DEV}" >> $GITHUB_OUTPUT
          echo "version_staging=${VERSION_STAGING}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Generated versions:"
          echo "  Base: ${BASE_VERSION}"
          echo "  Dev: ${VERSION_DEV}"
          echo "  Staging: ${VERSION_STAGING}"
          echo "  Version Code: ${VERSION_CODE}"

  # COMMENTED OUT FOR TESTING - Only running migration flow
  # ci:
  #   name: Run All Tests & Builds
  #   uses: ./.github/workflows/ci-reusable.yml

  # COMMENTED OUT FOR TESTING - Only running migration flow
  # build-deploy-dev:
  #   name: Build & Deploy Dev
  #   runs-on: ubuntu-latest
  #   needs: [ci, parse-version]
  #   if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master'
  #   environment: dev
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Set up JDK 17
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'
  #
  #     - name: Setup Gradle
  #       uses: gradle/actions/setup-gradle@v3
  #
  #     - name: Create local.properties for Dev
  #       run: |
  #         echo "app_version=${{ needs.parse-version.outputs.base_version }}" >> local.properties
  #         echo "environment=dev" >> local.properties
  #         echo "dev_supabase_url=${{ secrets.SUPABASE_URL }}" >> local.properties
  #         echo "dev_supabase_key=${{ secrets.SUPABASE_KEY }}" >> local.properties
  #         echo "dev_server_url=https://dev-api.aryamahasangh.org" >> local.properties
  #         echo "staging_supabase_url=https://placeholder.supabase.co" >> local.properties
  #         echo "staging_supabase_key=placeholder-key" >> local.properties
  #         echo "staging_server_url=https://placeholder.com" >> local.properties
  #         echo "prod_supabase_url=https://placeholder.supabase.co" >> local.properties
  #         echo "prod_supabase_key=placeholder-key" >> local.properties
  #         echo "prod_server_url=https://placeholder.com" >> local.properties
  #
  #     - name: Build Web for Dev
  #       run: ./gradlew :composeApp:wasmJsBrowserDistribution
  #
  #     - name: Deploy to Netlify Dev
  #       uses: nwtgck/actions-netlify@v2.0
  #       with:
  #         publish-dir: './composeApp/build/dist/wasmJs/productionExecutable'
  #         production-branch: dev
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #         deploy-message: 'ðŸš€ Dev ${{ needs.parse-version.outputs.version_dev }} - ${{ github.sha }}'
  #         enable-pull-request-comment: false
  #         enable-commit-comment: true
  #         enable-commit-status: true
  #       env:
  #         NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
  #         NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
  #
  #     - name: Build Android APK for Dev
  #       run: ./gradlew :composeApp:assembleDebug
  #
  #     - name: Rename APK with version
  #       run: |
  #         mkdir -p artifacts
  #         APK_SRC=$(find composeApp/build/outputs/apk/debug -type f -name '*-debug.apk' | head -n1)
  #         if [ -n "$APK_SRC" ]; then
  #           cp "$APK_SRC" "artifacts/AryaMahasangh-${{ needs.parse-version.outputs.version_dev }}.apk"
  #         fi
  #
  #     - name: Upload Dev Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: dev-artifacts-${{ needs.parse-version.outputs.version_dev }}
  #         path: |
  #           artifacts/
  #           composeApp/build/dist/wasmJs/productionExecutable/
  #         retention-days: 7

  # Database migration for staging
  migrate-to-staging:
    name: ðŸ—„ï¸ Migrate Dev â†’ Staging
    runs-on: ubuntu-latest
    needs: [parse-version]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: staging  # Access staging secrets as TARGET
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create local.properties with both dev and staging secrets
        run: |
          cat > local.properties << EOF
          # Dev (Source) - hardcoded (dev environment is not production-sensitive)
          dev_project_ref=afjtpdeohgdgkrwayayn
          dev_db_password=VZo7qmtmXAJ4bWS4
          dev_supabase_url=https://afjtpdeohgdgkrwayayn.supabase.co
          
          # Staging (Target) - from environment secrets
          staging_project_ref=${{ vars.SUPABASE_PROJECT_REF }}
          staging_db_password=${{ secrets.SUPABASE_DB_PASSWORD }}
          staging_supabase_url=${{ secrets.SUPABASE_URL }}
          EOF

      - name: Make migration script executable
        run: chmod +x migrate-direct.sh

      - name: Run migration (non-interactive)
        run: |
          echo "ðŸš€ Running migration dev â†’ staging (non-interactive mode)..."
          ./migrate-direct.sh dev-to-staging --non-interactive

      - name: Upload migration artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-dev-to-staging-${{ needs.parse-version.outputs.version_staging }}
          path: supabase/migrations/migration_dev_to_staging_*/
          retention-days: 90
          if-no-files-found: warn

  migrate-to-production:
    name: ðŸ—„ï¸ Migrate Staging â†’ Production
    runs-on: ubuntu-latest
    needs: [parse-version, migrate-to-staging]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment: production  # Requires manual approval + access to prod secrets
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create local.properties with staging and prod secrets
        run: |
          cat > local.properties << EOF
          # Staging (Source) - hardcoded (staging is not production-sensitive)
          staging_project_ref=ftnwwiwmljcwzpsawdmf
          staging_db_password=QwUaIJHBEh3nfsxy
          staging_supabase_url=https://ftnwwiwmljcwzpsawdmf.supabase.co
          
          # Production (Target) - from environment secrets
          prod_project_ref=${{ vars.SUPABASE_PROJECT_REF }}
          prod_db_password=${{ secrets.SUPABASE_DB_PASSWORD }}
          prod_supabase_url=${{ secrets.SUPABASE_URL }}
          EOF

      - name: Make migration script executable
        run: chmod +x migrate-direct.sh

      - name: Run migration to production (non-interactive)
        run: |
          echo "ðŸš€ Running migration staging â†’ production (non-interactive mode)..."
          ./migrate-direct.sh staging-to-prod --non-interactive

      - name: Upload migration artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-staging-to-prod-${{ needs.parse-version.outputs.version_staging }}
          path: supabase/migrations/migration_staging_to_prod_*/
          retention-days: 90
          if-no-files-found: warn
